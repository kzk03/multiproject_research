# IRL時系列予測の仕組みと予測期間の説明

## 質問: 時系列予測にすると予測期間はどうなる？

## 回答: 予測期間は**変わりません**

時系列予測に切り替えても、**予測対象の期間（将来窓）は同じ**です。

### 現在（スナップショット予測）
- **入力**: 訓練期間（6-9m: 2021-07-01～2021-10-01）の**最終時点のみ**の状態・行動
- **予測**: 評価期間（6-9m: 2023-07-01～2023-10-01）の継続確率
- **将来窓**: 評価期間終了から6-9ヶ月後（2024-01-01～2024-04-01）に依頼があるか？

### 時系列予測に変更後
- **入力**: 訓練期間（6-9m: 2021-07-01～2021-10-01）の**全期間の時系列データ**
- **予測**: 評価期間（6-9m: 2023-07-01～2023-10-01）の継続確率
- **将来窓**: 評価期間終了から6-9ヶ月後（2024-01-01～2024-04-01）に依頼があるか？（**同じ**）

## 違いは「入力データ」だけ

### スナップショット予測（現在）

```
訓練期間（3ヶ月）
2021-07-01 ─────────────── 2021-10-01
                               ↑
                            最終時点のみ使用
                            state: [14次元]
                            action: [5次元]
                               ↓
                            LSTM (seq_len=1)
                               ↓
                         継続確率: 0.83
```

**問題点**:
- 3ヶ月間の活動パターン（増加傾向、減少傾向）を無視
- 最終時点のスナップショットしか見ていない

### 時系列予測（提案）

```
訓練期間（3ヶ月）
2021-07-01 ─────────────── 2021-10-01
    ↓          ↓          ↓      ↓
  月1       月1.5       月2    月3
  state     state     state  state  ← 各時点の状態
  action    action    action action ← 各時点の行動
    ↓          ↓          ↓      ↓
    └──────────┴──────────┴──────┘
                  ↓
           LSTM (seq_len=N)
           時系列パターンを学習
                  ↓
           継続確率: 0.92
```

**改善点**:
- 3ヶ月間の**活動パターン全体**を考慮
- 「最近活発化している」「徐々に減速している」などのトレンドを捉える
- LSTMの時系列学習能力を活用

## コード上の変更箇所

### [irl_predictor.py:626-706](src/review_predictor/model/irl_predictor.py#L626-L706)

**`predict_continuation_probability()`メソッド**（時系列版）:

```python
# 各ステップまでの履歴を使用して状態を構築
for i in range(len(actions)):
    step_history = activity_history[:i+1]  # ← 累積履歴
    step_state = self.extract_developer_state(developer, step_history, context_date)
    states.append(step_state)
    state_tensors.append(self.state_to_tensor(step_state))

state_seq = torch.stack(state_tensors).unsqueeze(0)  # [1, seq_len, state_dim]
action_seq = torch.stack(action_tensors).unsqueeze(0)  # [1, seq_len, action_dim]

# LSTMで時系列処理
lengths = torch.tensor([len(actions)], dtype=torch.long, device=self.device)
predicted_reward, predicted_continuation = self.network(
    state_seq, action_seq, lengths
)

# 最終ステップの予測を使用
continuation_prob = predicted_continuation.item()
```

**重要**: 予測値は**最終ステップの出力**を使用するため、予測期間は変わらない

## 時系列データの構築例

### 6-9mウィンドウ（3ヶ月）の場合

**訓練期間**: 2021-07-01 ～ 2021-10-01

**時系列データ**（開発者ごと）:
```python
[
    # 月1: 2021-07-01～2021-07-31
    {
        'state': [exp_days=730, total_reviews=50, activity_gap=5, ...],
        'action': [changes=3, reviews=5, response_time=12, ...]
    },
    # 月2: 2021-08-01～2021-08-31
    {
        'state': [exp_days=760, total_reviews=55, activity_gap=4, ...],
        'action': [changes=5, reviews=7, response_time=8, ...]
    },
    # 月3: 2021-09-01～2021-10-01
    {
        'state': [exp_days=790, total_reviews=62, activity_gap=3, ...],
        'action': [changes=8, reviews=10, response_time=6, ...]
    }
]
```

**seq_len = 3**（3ヶ月分）

**LSTMが学習するパターン**:
- 「月1→月2→月3で活動が増加している」 → 継続確率 **高**
- 「月1→月2→月3で活動が減少している」 → 継続確率 **低**

## 予測期間の定義（再確認）

### 訓練時
- **訓練期間**: 2021-07-01 ～ 2021-10-01（6-9m）
- **将来窓**: 訓練期間終了から6-9ヶ月後（2022-04-01～2022-07-01）
- **ラベル**: 将来窓に依頼あり=1、なし=0

### 評価時
- **評価期間**: 2023-07-01 ～ 2023-10-01（6-9m）
- **将来窓**: 評価期間終了から6-9ヶ月後（2024-04-01～2024-07-01）
- **ラベル**: 将来窓に依頼あり=1、なし=0

**時系列予測に変更しても、この将来窓の定義は全く変わりません。**

## まとめ

| 項目 | スナップショット | 時系列 |
|------|-----------------|--------|
| 入力データ | 最終時点のみ | 全期間の時系列 |
| seq_len | 1 | 3～10（期間による） |
| LSTM活用 | ❌（形式的） | ✅（時系列学習） |
| 予測期間 | 6-9m後 | **6-9m後（同じ）** |
| 将来窓 | 2024-04-01～2024-07-01 | **同じ** |
| 予測対象 | 継続/離脱 | **同じ** |

**結論**: 時系列予測に切り替えても、**予測期間（将来窓）は全く変わりません**。変わるのは**入力として使う履歴データの範囲**だけです。

---

**作成日**: 2025年12月15日
