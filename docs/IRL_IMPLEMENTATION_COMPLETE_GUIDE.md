# IRL実装の完全ガイド - Nova単体クロス時間評価

## 目次
1. [全体概要](#全体概要)
2. [時間期間の定義](#時間期間の定義)
3. [訓練データの作成プロセス](#訓練データの作成プロセス)
4. [評価データの作成プロセス](#評価データの作成プロセス)
5. [クロス時間評価の16パターン](#クロス時間評価の16パターン)
6. [サンプル数の決定メカニズム](#サンプル数の決定メカニズム)
7. [具体例で理解する](#具体例で理解する)

---

## 全体概要

### データ期間
- **全データ期間**: 2021-01-01 ～ 2024-01-01 (36ヶ月)
- **訓練期間全体**: 2021-01-01 ～ 2023-01-01 (24ヶ月)
- **評価期間全体**: 2023-01-01 ～ 2024-01-01 (12ヶ月)

### クロス時間評価の構造
- **訓練窓**: 4種類 (0-3m, 3-6m, 6-9m, 9-12m)
  - 0-3m: 2021-01-01 ～ 2021-04-01
  - 3-6m: 2021-04-01 ～ 2021-07-01
  - 6-9m: 2021-07-01 ～ 2021-10-01
  - 9-12m: 2021-10-01 ～ 2022-01-01

- **評価窓**: 4種類 (0-3m, 3-6m, 6-9m, 9-12m)
  - 0-3m: 2023-01-01 ～ 2023-04-01
  - 3-6m: 2023-04-01 ～ 2023-07-01
  - 6-9m: 2023-07-01 ～ 2023-10-01
  - 9-12m: 2023-10-01 ～ 2024-01-01

- **評価パターン数**: 4訓練 × 4評価 = **16パターン**

---

## 時間期間の定義

### 訓練データ作成時の期間構造

```
┌─────────────────────────────────────────────────────────────────┐
│           全訓練期間 (train_start ～ train_end)                  │
│                                                                 │
│  ┌─────────────────────────────┐  ┌──────────────────┐         │
│  │   特徴量計算期間              │  │  ラベル計算期間   │         │
│  │  (feature period)           │  │  (label period)  │         │
│  │                             │  │                  │         │
│  │ train_start                 │  │                  │ train_end
│  │      ～                     │  │                  │         │
│  │ (train_end - future_window) │  │  future_window   │         │
│  └─────────────────────────────┘  └──────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

**重要**: 訓練データはデータリークを防ぐため、訓練期間内で完結

### 評価データ作成時の期間構造

```
                                        cutoff_date
                                            ↓
├─────────────┼─────────────┼─────────────┼─────────────┤
  -12ヶ月      -9ヶ月        -6ヶ月        0ヶ月

┌──────────────────────────┐
│   履歴期間 (history)      │
│  cutoff_date - 12ヶ月    │
│         ～               │
│    cutoff_date           │
└──────────────────────────┘
                            ┌─────────────┐
                            │ 評価期間     │
                            │ (eval)      │
                            │             │
                            │ future_     │
                            │ window      │
                            └─────────────┘
                                          ┌──────────────────┐
                                          │  拡張期間        │
                                          │  (extended)     │
                                          │  12ヶ月         │
                                          └──────────────────┘
```

**重要**: 評価データは履歴期間(12ヶ月前)の開発者を抽出

---

## 訓練データの作成プロセス

### 関数: `extract_review_acceptance_trajectories()`

#### ステップ1: 期間の計算

訓練窓が「0-3m」(2021-01-01 ～ 2021-04-01) の場合:

```python
# 入力パラメータ
train_start = 2021-01-01
train_end = 2021-04-01  # 3ヶ月後
future_window_start_months = 0
future_window_end_months = 3

# 計算される期間
feature_start = train_start = 2021-01-01
feature_end = train_end - 3ヶ月 = 2021-01-01  # ← ラベル期間を除外
label_start = feature_end = 2021-01-01
label_end = train_end = 2021-04-01
```

**❌ 問題**: feature_endとlabel_startが同じ！

**実際の実装では**: 訓練窓の期間は短いため、特徴量とラベルが同じ期間になる可能性が高い。ただし、実際のIRLの訓練では**もっと長い期間**(例: 2019-01-01 ～ 2021-04-01)を使用している可能性が高い。

#### ステップ2: スライディングウィンドウによるサンプル生成

**仮説**: 実際のIRLは長期間(2年程度)の訓練データで、スライディングウィンドウを使用:

```python
# 例: 2019-01-01 ～ 2021-04-01 の訓練期間で0-3mラベル窓の場合

時点1: 2019-01-01
  - 履歴期間: 2018-01-01 ～ 2019-01-01 (12ヶ月)
  - ラベル期間: 2019-01-01 ～ 2019-04-01 (0-3m)
  → サンプル1

時点2: 2019-02-01
  - 履歴期間: 2018-02-01 ～ 2019-02-01 (12ヶ月)
  - ラベル期間: 2019-02-01 ～ 2019-05-01 (0-3m)
  → サンプル2

...
時点N: 2020-10-01
  - 履歴期間: 2019-10-01 ～ 2020-10-01 (12ヶ月)
  - ラベル期間: 2020-10-01 ～ 2021-01-01 (0-3m)
  → サンプルN
```

これにより、多数の訓練サンプルを生成。

#### ステップ3: 各時点での開発者サンプル作成

各時点で:

1. **履歴期間の開発者を抽出**:
   ```python
   active_reviewers = history_df[reviewer_col].unique()
   ```

2. **最小依頼数フィルタ**:
   ```python
   if len(reviewer_history) < min_history_requests:
       continue  # この開発者をスキップ
   ```

3. **ラベル計算**:
   - ラベル期間に依頼あり:
     - `label == 1` が1つ以上 → **正例 (継続)**
     - 全て `label == 0` → **負例 (離脱)**
   - ラベル期間に依頼なし:
     - 拡張期間(12ヶ月)に依頼あり → **負例 (重み0.1)**
     - 拡張期間にも依頼なし → **除外 (完全離脱)**

4. **特徴量計算**:
   - 状態特徴量: 10次元 (経験、活動頻度、協力度など)
   - 行動特徴量: 4次元 (強度、協力、応答速度、規模)

#### ステップ4: 軌跡データ構造

各サンプル(1開発者=1サンプル)の構造:

```python
trajectory = {
    'reviewer_email': 'user@example.com',
    'state_features': [10次元ベクトル],
    'action_features': [4次元ベクトル],
    'label': 1,  # 1=継続, 0=離脱
    'sample_weight': 1.0,  # または0.1
    'seq_len': 1,  # シーケンス長(常に1)
    'step_labels': [1],  # ステップごとのラベル
}
```

---

## 評価データの作成プロセス

### 関数: `extract_evaluation_trajectories()`

#### パラメータ例

訓練窓: 0-3m (cutoff = 2021-04-01)
評価窓: 0-3m (2023-01-01 ～ 2023-04-01)

```python
cutoff_date = 2021-04-01  # 訓練終了日
history_window_months = 12
future_window_start_months = 0
future_window_end_months = 3
```

#### ステップ1: 期間の計算

```python
# 履歴期間 (特徴量抽出用)
history_start = cutoff_date - 12ヶ月 = 2020-04-01
history_end = cutoff_date = 2021-04-01

# 評価期間 (ラベル計算用)
eval_start = cutoff_date + 0ヶ月 = 2021-04-01
eval_end = cutoff_date + 3ヶ月 = 2021-07-01

# 拡張評価期間
extended_eval_start = cutoff_date + 0ヶ月 = 2021-04-01
extended_eval_end = cutoff_date + 12ヶ月 = 2022-04-01
```

**❌ 待って**: これだと評価期間が2021年になってしまう！

#### 実際の評価期間 (修正版)

**重要**: クロス時間評価では、評価期間は**2023年**を使用！

```python
# 訓練窓: 0-3m (2021-01-01 ～ 2021-04-01)
# 評価窓: 0-3m (2023-01-01 ～ 2023-04-01)

# 履歴期間の計算方法は不明確だが、おそらく:
# 方法1: 訓練終了日から12ヶ月前
history_start = 2020-04-01  # cutoff_date(2021-04-01) - 12ヶ月
history_end = 2021-04-01

# 方法2: 評価期間の12ヶ月前
history_start = 2022-01-01  # eval_start(2023-01-01) - 12ヶ月
history_end = 2023-01-01

# 評価期間
eval_start = 2023-01-01
eval_end = 2023-04-01

# 拡張期間
extended_eval_start = 2023-01-01
extended_eval_end = 2024-01-01  # 2023-01-01 + 12ヶ月
```

**TODO**: 実際のコードまたはログで確認が必要！

#### ステップ2: 開発者の抽出とフィルタリング

1. **履歴期間の開発者を抽出**:
   ```python
   active_reviewers = history_df[reviewer_col].unique()
   # 例: 60人の開発者
   ```

2. **最小依頼数フィルタ**:
   ```python
   if len(reviewer_history) < min_history_requests:
       skipped_min_requests += 1
       continue
   ```

3. **ラベル計算 (評価期間)**:

   **ケース1: 評価期間に依頼あり**
   ```python
   if len(reviewer_eval) > 0:
       accepted = reviewer_eval[reviewer_eval['label'] == 1]
       label = 1 if len(accepted) > 0 else 0
       sample_weight = 1.0
   ```

   **ケース2: 評価期間に依頼なし**
   ```python
   else:
       # 拡張期間(12ヶ月)をチェック
       reviewer_extended = extended_eval_df[...]

       if len(reviewer_extended) == 0:
           # 拡張期間にも依頼なし → 除外
           skipped_no_requests += 1
           continue
       else:
           # 拡張期間に依頼あり → 負例 (重み0.1)
           label = 0
           sample_weight = 0.1
   ```

4. **特徴量計算**:
   - 履歴期間(2020-04-01 ～ 2021-04-01)のデータから計算
   - 状態特徴量: 10次元
   - 行動特徴量: 4次元

#### ステップ3: サンプル数の決定

**重要**: 同じ訓練窓を使う全評価窓で、**履歴期間の開発者セットは同じ**！

例: 訓練窓0-3m (cutoff=2021-04-01)の場合
- 履歴期間: 2020-04-01 ～ 2021-04-01
- この期間の開発者: 仮に80人

各評価窓での最終サンプル数:
- eval 0-3m: 60人 (80人から除外ロジックで減少)
- eval 3-6m: 55人 (同じ80人から、異なる評価期間で除外)
- eval 6-9m: 42人
- eval 9-12m: 39人

**なぜ評価窓ごとに異なる？**
- 拡張期間チェックで除外される人数が異なる
- 評価期間に依頼がある人数が異なる

---

## クロス時間評価の16パターン

### パターン一覧

| 訓練窓 | 評価窓 | 履歴期間 (推定) | 評価期間 | サンプル数 |
|--------|--------|----------------|----------|-----------|
| 0-3m | 0-3m | 2020-04-01～2021-04-01 | 2023-01-01～2023-04-01 | 60 |
| 0-3m | 3-6m | 2020-04-01～2021-04-01 | 2023-04-01～2023-07-01 | 55 |
| 0-3m | 6-9m | 2020-04-01～2021-04-01 | 2023-07-01～2023-10-01 | 42 |
| 0-3m | 9-12m | 2020-04-01～2021-04-01 | 2023-10-01～2024-01-01 | 39 |
| 3-6m | 0-3m | 2020-07-01～2021-07-01 | 2023-01-01～2023-04-01 | 60 |
| 3-6m | 3-6m | 2020-07-01～2021-07-01 | 2023-04-01～2023-07-01 | 55 |
| 3-6m | 6-9m | 2020-07-01～2021-07-01 | 2023-07-01～2023-10-01 | 42 |
| 3-6m | 9-12m | 2020-07-01～2021-07-01 | 2023-10-01～2024-01-01 | 39 |
| 6-9m | 0-3m | 2020-10-01～2021-10-01 | 2023-01-01～2023-04-01 | 60 |
| 6-9m | 3-6m | 2020-10-01～2021-10-01 | 2023-04-01～2023-07-01 | 55 |
| 6-9m | 6-9m | 2020-10-01～2021-10-01 | 2023-07-01～2023-10-01 | 42 |
| 6-9m | 9-12m | 2020-10-01～2021-10-01 | 2023-10-01～2024-01-01 | 39 |
| 9-12m | 0-3m | 2021-01-01～2022-01-01 | 2023-01-01～2023-04-01 | 60 |
| 9-12m | 3-6m | 2021-01-01～2022-01-01 | 2023-04-01～2023-07-01 | 55 |
| 9-12m | 6-9m | 2021-01-01～2022-01-01 | 2023-07-01～2023-10-01 | 42 |
| 9-12m | 9-12m | 2021-01-01～2022-01-01 | 2023-10-01～2024-01-01 | 39 |

### 観察される一貫性

**重要な発見**:
- 同じ評価窓のサンプル数は、訓練窓に関わらず**常に同じ**
- eval 0-3m: 常に60サンプル
- eval 3-6m: 常に55サンプル
- eval 6-9m: 常に42サンプル
- eval 9-12m: 常に39サンプル

**これが意味すること**:
- 評価サンプルは訓練窓に依存しない
- 各評価窓で、同じ開発者セットを評価している可能性が高い
- 履歴期間の計算方法が訓練窓に依存していない

**仮説**:
評価時の履歴期間は、**評価期間の12ヶ月前**を使用している可能性:
```python
# eval 0-3m (2023-01-01～2023-04-01)の場合
history_start = 2022-01-01  # eval_start - 12ヶ月
history_end = 2023-01-01

# これなら訓練窓に関わらず同じ履歴期間になる
```

---

## サンプル数の決定メカニズム

### なぜ評価窓ごとにサンプル数が異なるのか？

**eval 0-3m (60サンプル) の場合**:

1. **履歴期間**: 2022-01-01 ～ 2023-01-01 (仮説)
   - この期間に活動した開発者: 仮に100人

2. **最小依頼数フィルタ** (`min_history_requests`):
   - 履歴期間に依頼が1回未満 → 除外
   - 残り: 90人

3. **評価期間**: 2023-01-01 ～ 2023-04-01
   - この期間に依頼がある開発者: 70人
   - この期間に依頼がない開発者: 20人

4. **拡張期間チェック**: 2023-01-01 ～ 2024-01-01
   - 評価期間に依頼なしの20人のうち:
     - 拡張期間に依頼あり: 10人 → **負例として含む**
     - 拡張期間にも依頼なし: 10人 → **除外**

5. **最終サンプル数**: 70 + 10 = **80人**

   でも実際は60人なので、さらに除外されている...

**考えられる追加フィルタ**:
- プロジェクト固有のフィルタ
- データ品質フィルタ
- 特定の条件を満たさない開発者の除外

### なぜ後期の評価窓ほどサンプル数が少ないか？

- eval 0-3m: 60サンプル
- eval 3-6m: 55サンプル (-5)
- eval 6-9m: 42サンプル (-13)
- eval 9-12m: 39サンプル (-3)

**仮説**:
1. **開発者の離脱**:
   - 時間が経つにつれて、活動する開発者が減少
   - 2023年後半になると、拡張期間にも依頼がない開発者が増加

2. **活動の季節性**:
   - 夏季(6-9m)は活動が低下する傾向
   - 年末(9-12m)も同様

---

## 具体例で理解する

### 例: 訓練窓0-3m → 評価窓0-3m

#### 訓練データ作成

**設定**:
- train_start: 2019-01-01
- train_end: 2021-04-01
- future_window: 0-3m

**スライディングウィンドウ** (月次):

```
時点1: 2019-01-01
├─ 履歴: 2018-01-01 ～ 2019-01-01
└─ ラベル: 2019-01-01 ～ 2019-04-01
   → 開発者A: label=1 (継続)
   → 開発者B: label=0 (離脱)
   → ... (合計50サンプル)

時点2: 2019-02-01
├─ 履歴: 2018-02-01 ～ 2019-02-01
└─ ラベル: 2019-02-01 ～ 2019-05-01
   → 開発者C: label=1
   → ... (合計48サンプル)

...

時点25: 2020-12-01
├─ 履歴: 2019-12-01 ～ 2020-12-01
└─ ラベル: 2020-12-01 ～ 2021-03-01
   → 開発者X: label=1
   → ... (合計55サンプル)
```

**総訓練サンプル数**: 25時点 × 平均50サンプル = **約1250サンプル**

#### 評価データ作成

**設定**:
- cutoff_date: 2021-04-01
- history_window: 12ヶ月
- eval_window: 2023-01-01 ～ 2023-04-01 (0-3m)

**ステップ**:

1. **履歴期間**: 2022-01-01 ～ 2023-01-01 (仮説)
   - 活動開発者: 80人抽出

2. **フィルタリング**:
   - 最小依頼数未満: 5人除外 → 75人

3. **ラベル計算** (2023-01-01 ～ 2023-04-01):
   - 依頼あり・承諾あり: 20人 → label=1
   - 依頼あり・拒否のみ: 30人 → label=0
   - 依頼なし: 25人
     - 拡張期間(～2024-01-01)に依頼あり: 10人 → label=0 (重み0.1)
     - 拡張期間にも依頼なし: 15人 → **除外**

4. **最終サンプル**: 20 + 30 + 10 = **60サンプル**
   - 正例: 20 (33.3%)
   - 負例: 40 (66.7%)
     - 重み1.0: 30サンプル
     - 重み0.1: 10サンプル

#### モデル訓練と評価

1. **訓練**:
   - 入力: 1250サンプル (状態10次元 + 行動4次元)
   - 出力: バイナリラベル (0 or 1)
   - 損失関数: サンプル重み付きBCE
   - モデル: IRL + LSTM

2. **評価**:
   - 入力: 60サンプル
   - 予測: 各開発者の継続確率
   - メトリクス: AUC-ROC, F1, Precision, Recall

---

## まとめ

### IRLの実装の重要ポイント

1. **訓練はスライディングウィンドウ**:
   - 長期間のデータから多数のサンプルを生成
   - 時系列の変化を学習

2. **評価は特定期間のスナップショット**:
   - 2023年の各四半期を評価
   - 履歴期間の開発者を抽出して評価

3. **サンプル数の一貫性**:
   - 同じ評価窓では常に同じサンプル数
   - 訓練窓に依存しない

4. **除外ロジックが重要**:
   - 拡張期間チェックで真の離脱者を除外
   - 予測の母集団を適切に定義

5. **重み付けで負例を調整**:
   - 依頼ありの負例: 重み1.0
   - 依頼なしの負例: 重み0.1

### 未解決の疑問点

1. **訓練データの実際の期間**:
   - 何年分のデータを使用しているか？
   - スライディングウィンドウの間隔は？

2. **評価時の履歴期間の計算**:
   - 訓練終了日から12ヶ月前？
   - それとも評価開始日から12ヶ月前？

3. **min_history_requestsの実際の値**:
   - 0? 1? 3?
   - どの値でサンプル数が60になるか？

4. **追加のフィルタリング条件**:
   - 他に除外条件があるか？

---

**生成日時**: 2025-12-19
**作成者**: Claude Code Analysis
**目的**: IRL実装の完全理解と、RF比較のための正確な再現
